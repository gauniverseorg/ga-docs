name: SSH into Instance

on:
  push:
    branches:
      - master

jobs:
  ssh:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install ssh client
      run: sudo apt-get install -y sshpass
    - name: SSH into instance and execute commands
      run: |
        sshpass -p 'Qmobilea34@' ssh -o StrictHostKeyChecking=no -p 22 ubuntu@44.195.207.159 "cd /home/ubuntu/ga-docs && rm -rf build && npm i && npm run build && cd /home/ubuntu/typesense-docsearch-scraper/"

    - name: Run Docker command
      run: |
        sshpass -p 'Qmobilea34@' ssh -o StrictHostKeyChecking=no -p 22 ubuntu@44.195.207.159 "sudo docker run -it --env-file=/home/ubuntu/ga-docs/.env -e 'CONFIG=\$(cat /home/ubuntu/ga-docs/typesense-docsearch-scraper/config.json | jq -r tostring)' typesense/docsearch-scraper:0.9.1"

    - name: Restart Nginx
      run: |
        sshpass -p 'Qmobilea34@' ssh -o StrictHostKeyChecking=no -p 22 ubuntu@44.195.207.159 "sudo systemctl restart nginx"

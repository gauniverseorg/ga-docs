name: deployment of ga-docss

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Install SSH Client
      run: sudo apt-get install -y openssh-client
      
    - name: SSH into EC2 instance
      uses: appleboy/ssh-action@master
      with:
        host: 44.195.207.159
        port: 22
        username: ubuntu
        password: Qmobilea34@
    - name: Check SSH connection
      run: |
         ssh -o "StrictHostKeyChecking=no" -o "BatchMode=yes" -o "ConnectTimeout=5" ubuntu@44.195.207.159 echo "SSH connection successful"
    - name: Go to directory and execute commands
      run: |
        cd /home/ubuntu/ga-docs
        sudo rm -rf build
        sudo npm i
        sudo npm run build

    - name: Run Docker container
      run: |
        cd /home/ubuntu/typesense-docsearch-scraper
        sudo docker run -it --env-file=/home/ubuntu/ga-docs/.env -e "CONFIG=$(cat config.json | jq -r tostring)" typesense/docsearch-scraper:0.9.1

    - name: Restart Nginx
      run: sudo systemctl restart nginx
